stages:
  - install
  - docker-build

maven-install:
  stage: install
  image: $DOCKER_REGISTRY/minimal-ubuntu:latest
  script:
    - mvn install -DskipTests
  artifacts:
    paths:
      - openmetadata-dist/target
  only:
    refs:
      - develop


docker-build:
  stage: docker-build
  image: $DOCKER_REGISTRY/docker:24.0.5
  dependencies:
    - maven-install
  needs: ["maven-install"]
  script:
    - DOCKER_BUILDKIT=1 docker build --build-arg DOCKER_REGISTRY=$DOCKER_REGISTRY --tag $DOCKER_HOST_URL/openmetadata-server:latest -f docker/development/Dockerfile .
    - docker login -u=$DOCKER_HOST_USER -p=$DOCKER_HOST_TOKEN $DOCKER_HOST_URL
    - docker push $DOCKER_HOST_URL/openmetadata-server:latest
    - docker rmi -f $DOCKER_HOST_URL/openmetadata-server:latest
  only:
    refs:
      - develop

